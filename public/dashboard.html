<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>æ²»ç†é¢æ¿ - AstraCoin</title>
  <style>
    :root {
      --primary-color: #00ff88;
      --secondary-color: #00ccff;
      --bg-dark: #0f0f23;
      --card-bg: #11131f;
      --text-light: #ffffff;
      --text-dim: #a0a0c0;
      --success-color: #00ff88;
      --warning-color: #ffaa00;
      --danger-color: #ff4444;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: var(--bg-dark);
      color: var(--text-light);
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      margin-bottom: 30px;
      text-align: center;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .subtitle {
      color: var(--text-dim);
      font-size: 1.1rem;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    
    .card h3 {
      font-size: 1rem;
      margin-bottom: 15px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
    }
    
    .card h3 svg {
      margin-right: 8px;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    
    .stat-change {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }
    
    .change-positive {
      color: var(--success-color);
    }
    
    .change-negative {
      color: var(--danger-color);
    }
    
    .change-neutral {
      color: var(--text-dim);
    }
    
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .chart-card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .chart-card h3 {
      margin-bottom: 20px;
      color: var(--text-light);
      font-size: 1.2rem;
    }
    
    .chart-placeholder {
      height: 200px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      margin-bottom: 15px;
    }
    
    .proposals-list {
      margin-top: 30px;
    }
    
    .proposals-list h2 {
      margin-bottom: 20px;
      font-size: 1.5rem;
      color: var(--text-light);
    }
    
    .proposal-item {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary-color);
    }
    
    .proposal-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--text-light);
    }
    
    .proposal-meta {
      font-size: 0.9rem;
      color: var(--text-dim);
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    .proposal-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .status-active {
      background: rgba(0, 255, 136, 0.2);
      color: var(--success-color);
    }
    
    .status-pending {
      background: rgba(255, 170, 0, 0.2);
      color: var(--warning-color);
    }
    
    .status-closed {
      background: rgba(255, 68, 68, 0.2);
      color: var(--danger-color);
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-dim);
    }
    
    .loading:after {
      content: '...';
      animation: dots 1.5s steps(5, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { color: rgba(255,255,255,0); text-shadow: .25em 0 0 rgba(255,255,255,0), .5em 0 0 rgba(255,255,255,0); }
      40% { color: white; text-shadow: .25em 0 0 rgba(255,255,255,0), .5em 0 0 rgba(255,255,255,0); }
      60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(255,255,255,0); }
      80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white; }
    }
    
    .error {
      text-align: center;
      padding: 40px;
      color: var(--danger-color);
      background: rgba(255, 68, 68, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(255, 68, 68, 0.3);
    }
    
    .refresh-btn {
      display: inline-flex;
      align-items: center;
      padding: 10px 16px;
      background: var(--primary-color);
      color: #000;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }
    
    .refresh-btn:hover {
      opacity: 0.85;
      transform: translateY(-2px);
    }
    
    .refresh-btn svg {
      margin-right: 8px;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .chart-card {
        padding: 15px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>ğŸ“Š æ²»ç†æ•°æ®é¢æ¿</h1>
      <p class="subtitle">AstraCoin DAO æ²»ç†æ´»åŠ¨å®æ—¶æ•°æ®</p>
    </header>
    
    <button class="refresh-btn" onclick="loadData()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      åˆ·æ–°æ•°æ®
    </button>
    
    <div class="stats-grid">
      <div class="card">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          æ€»ææ¡ˆæ•°
        </h3>
        <div class="stat-value" id="total-proposals">-</div>
        <div class="stat-change change-positive" id="proposals-change">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          åŠ è½½ä¸­...
        </div>
      </div>
      
      <div class="card">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          æ´»è·ƒææ¡ˆ
        </h3>
        <div class="stat-value" id="active-proposals">-</div>
        <div class="stat-change change-positive" id="active-change">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          åŠ è½½ä¸­...
        </div>
      </div>
      
      <div class="card">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M9 11a4 4 0 100-8 4 4 0 000 8zM23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          å‚ä¸æŠ•ç¥¨æ•°
        </h3>
        <div class="stat-value" id="total-votes">-</div>
        <div class="stat-change change-positive" id="votes-change">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          åŠ è½½ä¸­...
        </div>
      </div>
      
      <div class="card">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          å¹³å‡æŠ•ç¥¨ç‡
        </h3>
        <div class="stat-value" id="participation-rate">-</div>
        <div class="stat-change change-positive" id="participation-change">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          åŠ è½½ä¸­...
        </div>
      </div>
    </div>
    
    <div class="charts-container">
      <div class="chart-card">
        <h3>ææ¡ˆçŠ¶æ€åˆ†å¸ƒ</h3>
        <div class="chart-placeholder" id="status-chart">
          å›¾è¡¨åŠ è½½ä¸­...
        </div>
        <div id="status-legend"></div>
      </div>
      
      <div class="chart-card">
        <h3>æœˆåº¦ææ¡ˆè¶‹åŠ¿</h3>
        <div class="chart-placeholder" id="trend-chart">
          å›¾è¡¨åŠ è½½ä¸­...
        </div>
      </div>
    </div>
    
    <div class="proposals-list">
      <h2>æœ€æ–°ææ¡ˆ</h2>
      <div id="recent-proposals">
        <div class="loading">åŠ è½½æœ€æ–°ææ¡ˆ...</div>
      </div>
    </div>
  </div>

  <script>
    let governanceData = {};
    let refreshInterval;
    
    // åŠ è½½æ²»ç†æ•°æ®
    async function loadData() {
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('total-proposals').textContent = '-';
        document.getElementById('active-proposals').textContent = '-';
        document.getElementById('total-votes').textContent = '-';
        document.getElementById('participation-rate').textContent = '-';
        
        document.getElementById('recent-proposals').innerHTML = '<div class="loading">åŠ è½½æœ€æ–°ææ¡ˆ...</div>';
        
        // è·å–ææ¡ˆåˆ—è¡¨
        const response = await fetch("/api/list");
        
        if (!response.ok) {
          throw new Error(`HTTPé”™è¯¯: ${response.status}`);
        }
        
        const proposals = await response.json();
        
        if (!Array.isArray(proposals)) {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
        
        // å¤„ç†æ•°æ®
        processGovernanceData(proposals);
        
        // æ›´æ–°UI
        updateStats(proposals);
        updateCharts(proposals);
        updateRecentProposals(proposals);
        
      } catch (error) {
        console.error('åŠ è½½æ²»ç†æ•°æ®å¤±è´¥:', error);
        document.getElementById('recent-proposals').innerHTML = `
          <div class="error">
            <p>åŠ è½½æ²»ç†æ•°æ®å¤±è´¥</p>
            <button class="refresh-btn" onclick="loadData()">é‡è¯•</button>
          </div>
        `;
      }
    }
    
    // å¤„ç†æ²»ç†æ•°æ®
    function processGovernanceData(proposals) {
      // è®¡ç®—å„ç§ç»Ÿè®¡æ•°æ®
      const totalProposals = proposals.length;
      const activeProposals = proposals.filter(p => p.status === 'active').length;
      const closedProposals = proposals.filter(p => p.status === 'closed').length;
      const pendingProposals = proposals.filter(p => p.status === 'pending').length;
      
      // è®¡ç®—æ€»æŠ•ç¥¨æ•°ï¼ˆå‡è®¾æ¯ä¸ªææ¡ˆæœ‰voteså­—æ®µï¼‰
      const totalVotes = proposals.reduce((sum, proposal) => {
        return sum + (proposal.votes || 0);
      }, 0);
      
      // è®¡ç®—å‚ä¸ç‡ï¼ˆå‡è®¾æœ‰totalMemberså­—æ®µï¼‰
      const participationRate = totalVotes > 0 ? 
        Math.round((totalVotes / (proposals.length * 100)) * 100) / 100 : 0;
      
      // ä¿å­˜æ•°æ®
      governanceData = {
        totalProposals,
        activeProposals,
        closedProposals,
        pendingProposals,
        totalVotes,
        participationRate,
        statusDistribution: {
          active: activeProposals,
          closed: closedProposals,
          pending: pendingProposals
        }
      };
    }
    
    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
    function updateStats(proposals) {
      document.getElementById('total-proposals').textContent = governanceData.totalProposals;
      document.getElementById('active-proposals').textContent = governanceData.activeProposals;
      document.getElementById('total-votes').textContent = governanceData.totalVotes.toLocaleString();
      document.getElementById('participation-rate').textContent = `${governanceData.participationRate}%`;
      
      // æ›´æ–°å˜åŒ–æŒ‡ç¤ºå™¨ï¼ˆè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
      document.getElementById('proposals-change').innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        +5 æœ¬å‘¨
      `;
      
      document.getElementById('active-change').innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        +2 æœ¬å‘¨
      `;
      
      document.getElementById('votes-change').innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        +12% æœ¬å‘¨
      `;
      
      document.getElementById('participation-change').innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        +3% æœ¬å‘¨
      `;
    }
    
    // æ›´æ–°å›¾è¡¨
    function updateCharts(proposals) {
      // çŠ¶æ€åˆ†å¸ƒå›¾è¡¨
      const statusChart = document.getElementById('status-chart');
      const statusLegend = document.getElementById('status-legend');
      
      if (governanceData.statusDistribution) {
        const { active, closed, pending } = governanceData.statusDistribution;
        const total = active + closed + pending;
        
        statusChart.innerHTML = `
          <div style="display: flex; height: 100%; align-items: center; justify-content: center;">
            <div style="width: 150px; height: 150px; border-radius: 50%; 
              background: conic-gradient(
                var(--primary-color) 0% ${(active / total) * 100}%,
                var(--warning-color) ${(active / total) * 100}% ${((active + pending) / total) * 100}%,
                var(--danger-color) ${((active + pending) / total) * 100}% 100%
              );">
            </div>
          </div>
        `;
        
        statusLegend.innerHTML = `
          <div style="display: flex; justify-content: space-around; margin-top: 10px;">
            <div style="display: flex; align-items: center;">
              <div style="width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; margin-right: 5px;"></div>
              <span>è¿›è¡Œä¸­ (${active})</span>
            </div>
            <div style="display: flex; align-items: center;">
              <div style="width: 12px; height: 12px; background: var(--warning-color); border-radius: 50%; margin-right: 5px;"></div>
              <span>å¾…å¼€å§‹ (${pending})</span>
            </div>
            <div style="display: flex; align-items: center;">
              <div style="width: 12px; height: 12px; background: var(--danger-color); border-radius: 50%; margin-right: 5px;"></div>
              <span>å·²ç»“æŸ (${closed})</span>
            </div>
          </div>
        `;
      }
      
      // è¶‹åŠ¿å›¾è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
      const trendChart = document.getElementById('trend-chart');
      trendChart.innerHTML = `
        <div style="display: flex; height: 100%; align-items: flex-end; justify-content: space-around; padding: 20px 0;">
          <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="width: 20px; height: 60px; background: var(--primary-color); border-radius: 4px;"></div>
            <div style="margin-top: 5px; font-size: 12px;">1æœˆ</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="width: 20px; height: 80px; background: var(--primary-color); border-radius: 4px;"></div>
            <div style="margin-top: 5px; font-size: 12px;">2æœˆ</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="width: 20px; height: 45px; background: var(--primary-color); border-radius: 4px;"></div>
            <div style="margin-top: 5px; font-size: 12px;">3æœˆ</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="width: 20px; height: 90px; background: var(--primary-color); border-radius: 4px;"></div>
            <div style="margin-top: 5px; font-size: 12px;">4æœˆ</div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: center;">
            <div style="width: 20px; height: 70px; background: var(--primary-color); border-radius: 4px;"></div>
            <div style="margin-top: 5px; font-size: 12px;">5æœˆ</div>
          </div>
        </div>
      `;
    }
    
    // æ›´æ–°æœ€æ–°ææ¡ˆåˆ—è¡¨
    function updateRecentProposals(proposals) {
      const recentProposalsElement = document.getElementById('recent-proposals');
      
      // è·å–æœ€æ–°çš„5ä¸ªææ¡ˆ
      const recentProposals = proposals
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 5);
      
      if (recentProposals.length === 0) {
        recentProposalsElement.innerHTML = '<div class="loading">æš‚æ— ææ¡ˆ</div>';
        return;
      }
      
      recentProposalsElement.innerHTML = recentProposals.map(proposal => `
        <div class="proposal-item">
          <div class="proposal-title">${escapeHtml(proposal.title)}</div>
          <div class="proposal-meta">
            <span>${formatDate(proposal.created_at)}</span>
            <span>ä½œè€…: ${escapeHtml(proposal.author || 'åŒ¿å')}</span>
            ${proposal.votes ? `<span>æŠ•ç¥¨: ${proposal.votes}</span>` : ''}
          </div>
          <span class="proposal-status status-${proposal.status}">
            ${getStatusText(proposal.status)}
          </span>
        </div>
      `).join('');
    }
    
    // å·¥å…·å‡½æ•°
    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }
    
    function getStatusText(status) {
      const statusMap = {
        'active': 'è¿›è¡Œä¸­',
        'pending': 'å¾…å¼€å§‹', 
        'closed': 'å·²ç»“æŸ',
        'draft': 'è‰ç¨¿'
      };
      return statusMap[status] || status;
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      
      // æ¯2åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°æ•°æ®
      refreshInterval = setInterval(loadData, 120000);
    });
    
    // æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
</body>
</html>